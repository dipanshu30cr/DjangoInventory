<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Form</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
{% include 'navbar.html' %}
<body class="bg-gray-100">
    <div class="container mx-auto my-5 p-5 bg-white shadow-md rounded">
        <h2 class="text-2xl font-bold mb-4">Purchase Entry</h2>

        <!-- PurchaseMaster Form -->
        <form action="{% url 'purchaseForm' %}" id="purchase-form"  method="POST">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Reference No (Autogenerated)</label>
                <input type="text" id="reference" name="reference" readonly
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Purchase Date</label>
                <input type="date" id="purchaseDate" name="purchaseDate" readonly
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <!-- <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Supplier</label>
                <select id="supplier" name="supplier"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    {% for supplier in suppliers %}
                    
                    <option value=" {{ supplier.SupplierId }}"> {{ supplier.SupplierName }}</option>
                    {% endfor %}
                </select>
            </div> -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Supplier</label>
                <select id="supplier" name="supplier" required
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="" selected disabled>Choose a supplier</option> <!-- Default option -->
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.SupplierId }}">{{ supplier.SupplierName }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <input type="hidden" name="PurchaseMasterstatus" value="1">

            <input type="hidden" name="PurchaseMasterEntryDate" value="{{ current_date }}">
            <!-- <input type="hidden" name="UserId" value="{{ user_uuid }}"> -->
            <!-- PurchaseDetails Form -->
            <h3 class="text-xl font-bold mb-4">Purchase Details</h3>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Item</label>
                <select id="item" name="item" required
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <!-- <option value="" selected disabled>Choose a Item</option> -->
                    {% for item in items %}
                    <option value="{{ item.ItemId }}" data-rate="{{ item.ItemRate }}" >{{ item.ItemName }} (Rate: {{ item.ItemRate }})</option>
                    {% endfor %}
                </select>
            </div>
            

            <!-- <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Quantity</label>
                <input type="number" id="quantity" name="quantity" min="1" value="1"
                required
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div> -->

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Quantity</label>
                <input type="number" id="quantity" name="quantity" min="1" value="1" required
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                    onkeydown="return event.key !== '-' && event.key !== 'e'" />
            </div>
            
            

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Amount (Auto-calculated)</label>
                <input type="text" id="amount" name="amount" readonly
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>
            <input type="hidden" name="PurchaseDetailsstatus" value="1">

            <input type="hidden" name="PurchaseDetailsEntryDate" value="{{ current_date }}">
            <!-- <input type="hidden" name="UserId" value="{{ user_uuid }}"> -->

            <button type="button" id="add-item" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Add Item
            </button>

            <!-- Temporary Table for Purchase Details -->
            <h3 class="text-xl font-bold mt-6 mb-4">Items Added</h3>
            <table class="min-w-full bg-white border">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th class="px-4 py-2">Item Name</th>
                        <th class="px-4 py-2">Quantity</th>
                        <th class="px-4 py-2">Amount</th>
                        <th class="px-4 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody id="temp-table-body" class="text-center">
                    <!-- Dynamically added rows will appear here -->
                </tbody>
            </table>

            <div class="mt-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Total Amount</label>
                <input type="text" id="totalAmount" readonly
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <button type="submit"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4">Submit
            </button>
        </form>
    </div>

    <script>
        let tempTable = [];
        let totalAmount = 0;

        window.onload = function() {
            
            const randomRef = Math.floor(10000 + Math.random() * 90000);
            document.getElementById('reference').value = randomRef;

            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseDate').value = today;
        };

       
        function calculateAmount() {
            const item = document.getElementById('item');
            const itemRate = parseFloat(item.options[item.selectedIndex].getAttribute('data-rate'));
            const quantity = parseInt(document.getElementById('quantity').value);
            const amount = quantity * itemRate;
            document.getElementById('amount').value = amount;
        }

        document.getElementById('quantity').addEventListener('input', calculateAmount);
        document.getElementById('item').addEventListener('change', calculateAmount);

        document.getElementById('add-item').addEventListener('click', function () {
            const item = document.getElementById('item');
            const itemName = item.options[item.selectedIndex].text;
            const itemId = item.value;
            const quantity = document.getElementById('quantity').value;
            const amount = document.getElementById('amount').value;

            
            if (tempTable.some(item => item.itemId === itemId)) {
                alert('Item already added!');
                return;
            }

            tempTable.push({
                itemId,
                itemName,
                quantity,
                amount
            });

            totalAmount += parseFloat(amount);

            const tbody = document.getElementById('temp-table-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${itemName}</td>
                <td>${quantity}</td>
                <td>${amount}</td>
                <td><button type="button" class="remove-item bg-red-500 text-white px-4 py-1 rounded">Remove</button></td>
            `;
            tbody.appendChild(row);

            document.getElementById('totalAmount').value = totalAmount;
            document.getElementById('quantity').value = 1;
            document.getElementById('amount').value = '';
        });

        document.getElementById('temp-table-body').addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-item')) {
                const row = e.target.closest('tr');
                const amount = parseFloat(row.children[2].innerText);

                // Remove item from tempTable
                const itemId = tempTable.find(item => item.itemName === row.children[0].innerText).itemId;
                tempTable = tempTable.filter(item => item.itemId !== itemId);

                totalAmount -= amount;
                document.getElementById('totalAmount').value = totalAmount;

                row.remove();
            }
        });

        document.getElementById('purchase-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const purchaseDetailsField = document.createElement('input');
            purchaseDetailsField.type = 'hidden';
            purchaseDetailsField.name = 'purchase_details';
            purchaseDetailsField.value = JSON.stringify(tempTable);
            this.appendChild(purchaseDetailsField);

            const totalAmountField = document.createElement('input');
            totalAmountField.type = 'hidden';
            totalAmountField.name = 'totalAmount';
            totalAmountField.value = totalAmount;
            this.appendChild(totalAmountField);

            this.submit();  // Now submit the form
        });

    </script>

</body>
</html>
