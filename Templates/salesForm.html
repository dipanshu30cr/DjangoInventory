<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Form</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>

<script>
    function validateItemName(input) {
        const pattern = /^[A-Za-z\s]*$/;
        const value = input.value;
        if (!pattern.test(value)) {
            document.getElementById('nameError').style.display = 'block';
        } else {
            document.getElementById('nameError').style.display = 'none';
        }
    }

    function validatePhone(input) {
        if (input.value.length !== 10) {
            document.getElementById('phoneError').style.display = 'block';
        } else {
            document.getElementById('phoneError').style.display = 'none';
        }
        if (input.value.length > 10 || input.value.length < 10) {
                input.value = input.value.slice(0, 10);
            }
    }

    function validateQuantity(input) {
        if (input.value <= 0) {
            document.getElementById('quantityError').style.display = 'block';
        } else {
            document.getElementById('quantityError').style.display = 'none';
        }
    }

    function validatePrice(input) {
        if (input.value <= 0) {
            document.getElementById('priceError').style.display = 'block';
        } else {
            document.getElementById('priceError').style.display = 'none';
        }
    }
</script>



{% include 'navbar.html' %}
<body class="bg-gray-100">
    {% if error_message %}
        <div class="alert alert-danger">
            {{ error_message }}
        </div>
    {% endif %}
    <div class="container mx-auto my-5 p-5 bg-white shadow-md rounded">
        <h2 class="text-2xl font-bold mb-4">Sales Entry</h2>



        <form action="{% url 'salesForm' %}" id="sales-form"  method="POST">
            {% csrf_token %}


            <div class="form-group mb-4">
                <label for="CustomerName" class="block text-gray-700 text-sm font-bold mb-2">Customer Name</label>
                <input type="text" id="CustomerName" name="CustomerName" required oninput="validateItemName(this)"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <small id="nameError" class="text-red-500 text-sm mt-1" style="display: none;">Please enter alphabets
                    only.</small>
            </div>

            
            <div class="form-group">
                <label for="CustomerPhone" class="block text-gray-700 text-sm font-bold mb-2">Customer Phone</label>
                <input type="number" id="CustomerPhone" name="CustomerPhone" required maxlength="10" minlength="10" oninput="validatePhone(this)"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <small id="phoneError" class="text-red-500 text-sm mt-1" style="display: none;">Phone number must be 10
                    digits.</small>
            </div>


            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Reference No (Autogenerated)</label>
                <input type="text" id="reference" name="reference" readonly
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Sales Date</label>
                <input type="date" id="SalesDate" name="SalesDate" min="1900-01-01" required
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>
            

            
            <input type="hidden" name="SalesMasterstatus" value="1">

            <input type="hidden" name="SalesMasterEntryDate" value="{{ current_date }}">
            


            <h3 class="text-xl font-bold mb-4">Sales Details</h3>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Item</label>
                <select id="item" name="item" required
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <!-- <option value="" selected disabled>Choose a Item</option> -->
                    {% for item in items %}
                    <!-- <option value="{{ item.PurchaseDetailsId }}" >{{ item.ItemAssigned.ItemName }}</option> -->
                    <option value="{{ item.ItemId }}" >{{ item.ItemName }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Quantity</label>
                <input type="number" id="quantity" name="quantity" min="1" value="1" required
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    oninput="validateQuantity(this)">
                <small id="quantityError" class="text-red-500 text-sm mt-1" style="display: none;">Quantity must be
                    greater than 0.</small>
            </div>

            <!-- Price Input -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Price</label>
                <input type="number" id="price" name="price" min="1" value="1" required
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    oninput="validatePrice(this)">
                <small id="priceError" class="text-red-500 text-sm mt-1" style="display: none;">Price must be greater
                    than 0.</small>
            </div>
            
            

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Amount (Auto-calculated)</label>
                <input type="text" id="amount" name="amount" readonly value="1"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <input type="hidden" name="SalesDetailsstatus" value="1">

            <input type="hidden" name="SalesDetailsEntryDate" value="{{ current_date }}">
            <!-- <input type="hidden" name="UserId" value="{{ user_uuid }}"> -->

            <button type="button" id="add-item" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Add Item
            </button>

            <h3 class="text-xl font-bold mt-6 mb-4">Items Added</h3>
            <table class="min-w-full bg-white border">
                <thead class="bg-gray-800 text-white">
                    <tr>
                        <th class="px-4 py-2">Item Name</th>
                        <th class="px-4 py-2">Quantity</th>
                        <th class="px-4 py-2">Price</th>
                        <th class="px-4 py-2">Amount</th>
                        <th class="px-4 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody id="temp-table-body" class="text-center">
                    <!-- Dynamically added rows will appear here -->
                </tbody>
            </table>
            

            <div class="mt-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Total Amount</label>
                <input type="text" id="totalAmount"  readonly
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <button type="submit"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4">Submit
            </button>
        </form>
    </div>

    <script>

        document.getElementById('SalesDate').max = new Date().toISOString().split('T')[0];

        
        let tempTable = [];
        let totalAmount = 0;

        window.onload = function() {
            // Set random reference number
            const randomRef = Math.floor(10000 + Math.random() * 90000);
            document.getElementById('reference').value = randomRef;

            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('salesDate').value = today;
        };

        // Function to calculate amount based on selected item and quantity
        function calculateAmount() {
                const itemRate = parseInt(document.getElementById('price').value);
                const quantity = parseInt(document.getElementById('quantity').value);
                const amount = quantity * itemRate;
                document.getElementById('amount').value = amount;
            }

            document.getElementById('price').addEventListener('input', calculateAmount);
            document.getElementById('quantity').addEventListener('input', calculateAmount);

            document.getElementById('add-item').addEventListener('click', function () {
                const item = document.getElementById('item');
                const itemName = item.options[item.selectedIndex].text;
                const itemId = item.value;
                const quantity = document.getElementById('quantity').value;
                const price = document.getElementById('price').value;  // Use the correct price value
                const amount = document.getElementById('amount').value;

                if (quantity <= 0 || price <= 0) {
                    alert('Quantity and Price must be greater than 0');
                    return;
                }

        // Reset values
                document.getElementById('quantity').value = 1;
                document.getElementById('price').value = 1;
                document.getElementById('amount').value = 1;


                // Check if item already exists
                if (tempTable.some(item => item.itemId === itemId)) {
                    alert('Item already added!');
                    return;
                }

                tempTable.push({
                    itemId,
                    itemName,
                    quantity,
                    price,
                    amount
                });

                totalAmount += parseFloat(amount);

                const tbody = document.getElementById('temp-table-body');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${itemName}</td>
                    <td>${quantity}</td>
                    <td>${price}</td>  <!-- Correct price is now displayed -->
                    <td>${amount}</td>
                    <td><button type="button" class="remove-item bg-red-500 text-white px-4 py-1 rounded">Remove</button></td>
                `;
                tbody.appendChild(row);

                // document.getElementById('totalAmount').value = totalAmount;
                // document.getElementById('quantity').value = 1;
                // document.getElementById('amount').value = '';

                document.getElementById('totalAmount').value = totalAmount;
                document.getElementById('quantity').value = 1;
                document.getElementById('price').value = 1;
                document.getElementById('amount').value = 1;
            });

            // Removing item and updating total amount
            document.getElementById('temp-table-body').addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-item')) {
                    const row = e.target.closest('tr');
                    const amount = parseFloat(row.children[3].innerText);  // Use the correct column for amount

                    // Remove item from tempTable
                    const itemId = tempTable.find(item => item.itemName === row.children[0].innerText).itemId;
                    tempTable = tempTable.filter(item => item.itemId !== itemId);

                    totalAmount -= amount;
                    document.getElementById('totalAmount').value = totalAmount;

                    row.remove();
                }
            });


        

        document.getElementById('sales-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const salesDetailsField = document.createElement('input');
            salesDetailsField.type = 'hidden';
            salesDetailsField.name = 'sales_details';
            salesDetailsField.value = JSON.stringify(tempTable);
            this.appendChild(salesDetailsField);

            const totalAmountField = document.createElement('input');
            totalAmountField.type = 'hidden';
            totalAmountField.name = 'totalAmount';
            totalAmountField.value = totalAmount;
            this.appendChild(totalAmountField);

            this.submit();  
        });

    </script>
    <script>
   
    function validateQuantity(input) {
        const itemId = document.getElementById("item").value; 
        const quantity = input.value; 
        const quantityError = document.getElementById("quantityError");

        // Clear any previous error messages
        quantityError.style.display = 'none';

        if (itemId === "") {
            quantityError.innerText = "Please select an item.";
            quantityError.style.display = 'block';
            return;
        }

        
        fetch(`/validate-quantity/?item_id=${itemId}&quantity=${quantity}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                
                quantityError.innerText = data.error;
                quantityError.style.display = 'block';
                input.value = 1;
                
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>


</body>
</html>
